/***************************************
*
*	Javascript Textile->HTML conversion
*
*	ben@ben-daglish.net (with thanks to John Hughes for improvements)
*   Issued under the "do what you like with it - I take no respnsibility" licence
****************************************/function convert_textile(e){function S(e){var i=e.split(/\r?\n/);s="",t=n=r=0;for(var a=0;a<i.length;a++)if(i[a].indexOf("[")==0){var f=i[a].indexOf("]");o[i[a].substring(1,f)]=i[a].substring(f+1)}for(a=0;a<i.length;a++){if(i[a].indexOf("[")==0)continue;if(v=g.exec(i[a])){A(1),t=1,s+=i[a].replace(g,"<p"+C(v[1])+">"+x(v[2]));continue}if(v=/^h(\d)(\S*)\.\s*(.*)/.exec(i[a])){A(1),s+=L("h"+v[1],C(v[2]),x(v[3]))+l;continue}if(v=y.exec(i[a])){A(1),t=1,s+=i[a].replace(y,'<p id="fn'+v[1]+'"><sup>'+v[1]+"</sup>"+x(v[2]));continue}if(i[a].indexOf("*")==0)h="<ul>",p="</ul>";else if(i[a].indexOf("#")==0)h="<ol>",p="</ol>";else{while(c>0)s+=p,c>1?s+="</li>":s+="\n",s+="\n",c--;h=""}if(h){A(1);var f=/^([*#]+)\s*(.*)/.exec(i[a]),m=f[1].length;while(m<c)s+=p+"</li>\n",c--;while(c<m)s=s.replace(/<\/li>\n$/,"\n"),s+=h,c++;s+=L("li","",x(f[2]))+"\n";continue}if(i[a].match(w)){A(1),d=1,s+=i[a].replace(w,'<table style="$1;">\n');continue}if(i[a].indexOf("|")==0||i[a].match(E)){A(1),d||(s+="<table>\n",d=1);var S="",T="",N=E.exec(i[a]);N&&(S=k("style",N[1]),i[a]=i[a].replace(E,"|"));var O=i[a].split("|");for(j=1;j<O.length-1;j++){var M="td";O[j].indexOf("_.")==0&&(M="th",O[j]=O[j].substring(2)),O[j]=x(O[j]);var _=/^([<>=^~\/\\\{]+.*?)\.(.*)/.exec(O[j]),D="",P="";if(_!=null){O[j]=_[2];var H=/\\(\d+)/.exec(_[1]);H!=null&&(D+=k("colspan",H[1]));var B=/\/(\d+)/.exec(_[1]);B!=null&&(D+=k("rowspan",B[1]));var F=/([\^~])/.exec(_[1]);F!=null&&(P+="vertical-align:"+u[F[1]]+";");var I=/(<>|=|<|>)/.exec(_[1]);I!=null&&(P+="text-align:"+u[I[1]]+";");var q=/\{([^\}]+)\}/.exec(_[1]);q!=null&&(P+=q[1]),P!=""&&(D+=k("style",P))}T+=L(M,D,O[j])}s+="	"+L("tr",S,T)+"\n";continue}d&&(s+="</table>"+l,d=0);if(i[a]=="")A();else if(!t){if(v=b.exec(i[a]))i[a]=i[a].replace(b,""),s+="<blockquote>",n=1,v[1]&&(r=1);s+="<p>"+x(i[a]),t=1}else s+=x(i[a])}return A(),s}function x(e){for(i in a)e=e.replace(new RegExp(i,"g"),a[i]);for(i in f)e=T(e,RegExp("^"+f[i]+"(.+?)"+f[i]),i,""),e=T(e,RegExp(" "+f[i]+"(.+?)"+f[i]),i," ");return e=e.replace(/\[(\d+)\]/g,'<sup><a href="#fn$1">$1</a></sup>'),e=e.replace(/([A-Z]+)\((.*?)\)/g,'<acronym title="$2">$1</acronym>'),e=e.replace(/\"([^\"]+)\":((http|https|mailto):\S+)/g,'<a href="$2">$1</a>'),e=N(e,/!([^!\s]+)!:(\S+)/),e=N(e,/!([^!\s]+)!/),e=e.replace(/"([^\"]+)":(\S+)/g,function(e,t,n){return L("a",k("href",o[n]),t)}),e=e.replace(/(=)?"([^\"]+)"/g,function(e,t,n){return t?e:"&#8220;"+n+"&#8221;"}),e}function T(e,t,n,r){while(m=t.exec(e)){var i=C(m[1]);m[1]=m[1].replace(/^[\[\{\(]\S+[\]\}\)]/g,""),m[1]=m[1].replace(/^[<>=()]+/,""),e=e.replace(t,r+L(n,i,m[1]))}return e}function N(e,t){var n=t.exec(e);if(n!=null){var r="",i="",s=/\((.*)\)$/.exec(n[1]);s!=null&&(r=k("alt",s[1])+k("title",s[1]),n[1]=n[1].replace(/\((.*)\)$/,"")),n[1].match(/^[><]/)&&(i="float:"+(n[1].indexOf(">")==0?"right;":"left;"),n[1]=n[1].replace(/^[><]/,""));var o=/(\(+)/.exec(n[1]);o&&(i+="padding-left:"+o[1].length+"em;");var u=/(\)+)/.exec(n[1]);u&&(i+="padding-right:"+u[1].length+"em;"),i&&(r+=k("style",i));var a='<img src="'+n[1]+'"'+r+" />";n.length>2&&(a=L("a",k("href",n[2]),a)),e=e.replace(t,a)}return e}function C(e){var t="",n="";if(!e)return"";var r=/\[(\w\w)\]/.exec(e);r!=null&&(n+=k("lang",r[1]));var i=/\((\S+)\)/.exec(e);i!=null&&(e=e.replace(/\((\S+)\)/,""),n+=i[1].replace(/#(.*)$/,' id="$1"').replace(/^(\S+)/,' class="$1"'));var s=/(<>|=|<|>)/.exec(e);s&&(t+="text-align:"+u[s[1]]+";");var o=/\{(\S+)\}/.exec(e);o&&(t+=o[1],o[1].match(/;$/)||(t+=";"));var a=/(\(+)/.exec(e);a&&(t+="padding-left:"+a[1].length+"em;");var f=/(\)+)/.exec(e);return f&&(t+="padding-right:"+f[1].length+"em;"),t&&(n+=k("style",t)),n}function k(e,t){return" "+e+'="'+t+'"'}function L(e,t,n){return"<"+e+t+">"+n+"</"+e+">"}function A(e){e&&(r=0),t&&(s+="</p>"+l,t=0),n&&!r&&(s+="</blockquote>"+l,n=0)}var t,n,r,s,o=new Array,u={">":"right","<":"left","=":"center","<>":"justify","~":"bottom","^":"top"},a={"'":"&#8217;"," - ":" &#8211; ","--":"&#8212;"," x ":" &#215; ","\\.\\.\\.":"&#8230;","\\(C\\)":"&#169;","\\(R\\)":"&#174;","\\(TM\\)":"&#8482;"},f={b:"\\*\\*",i:"__",em:"_",strong:"\\*",cite:"\\?\\?",sup:"\\^",sub:"~",span:"\\%",del:"-",code:"@",ins:"\\+",del:"-"},l="\n\n",c=0,h="",p="",d=0,v="",g=/^p(\S*)\.\s*(.*)/,y=/^fn(\d+)\.\s*(.*)/,b=/^bq\.(\.)?\s*/,w=/^table\s*{(.*)}\..*/,E=/^\{(\S+)\}\.\s*\|/;return S(e)};